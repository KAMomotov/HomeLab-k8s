name: Update image digest

on:
  repository_dispatch:
    types: [image_published]

permissions:
  contents: write
  packages: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Resolve payload
        id: payload
        env:
          APP: ${{ github.event.client_payload.app }}
          DIGEST: ${{ github.event.client_payload.digest }}
          TAG: ${{ github.event.client_payload.tag }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "app=${APP}"
          echo "digest=${DIGEST}"
          echo "tag=${TAG}"

          case "${APP}" in
            api|frontend) ;;
            *) echo "Unsupported app"; exit 1 ;;
          esac

          if [ -n "${DIGEST}" ]; then
            echo "${DIGEST}" | grep -Eq '^sha256:[0-9a-f]{64}$' || (echo "Bad digest"; exit 1)
          else
            TAG="${TAG:-latest}"
            IMAGE="ghcr.io/kamomotov/proofstack-${APP}:${TAG}"
            echo "Resolving digest for ${IMAGE}"
            DIGEST="$(skopeo inspect --creds "${GITHUB_ACTOR}:${GH_TOKEN}" --format '{{.Digest}}' "docker://${IMAGE}")"
            echo "${DIGEST}" | grep -Eq '^sha256:[0-9a-f]{64}$' || (echo "Failed to resolve digest"; exit 1)
          fi

          FILE="apps/proofstack/overlays/prod/patch-${APP}-image.yaml"
          IMAGE="ghcr.io/kamomotov/proofstack-${APP}@${DIGEST}"

          {
            echo "app=${APP}"
            echo "digest=${DIGEST}"
            echo "file=${FILE}"
            echo "image=${IMAGE}"
          } >> "$GITHUB_OUTPUT"

      - name: Update patch file
        env:
          FILE: ${{ steps.payload.outputs.file }}
          IMAGE: ${{ steps.payload.outputs.image }}
          APP: ${{ steps.payload.outputs.app }}
        run: |
          echo "Updating $FILE -> $IMAGE"
          sed -i -E "s|^\s*image:\s*ghcr\.io/kamomotov/proofstack-${APP}@sha256:[0-9a-f]{64}\s*$|          image: ${IMAGE}|" "$FILE"

          echo "Result:"
          grep -n "image:" "$FILE"

      - name: Commit & push
        run: |
          git config user.name "proofstack-bot"
          git config user.email "proofstack-bot@users.noreply.github.com"
          git add apps/proofstack/overlays/prod/patch-*-image.yaml
          git commit -m "chore(images): bump ${{ steps.payload.outputs.app }} to ${{ steps.payload.outputs.digest }}" || exit 0
          git push
